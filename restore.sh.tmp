#!/bin/bash
# set -x
# This file has to write the entire env into the envfile
# Expects relative path to state folder it's supposed to restore as arg
# TODO: Clean this up, this looks/is ugly

export INPUT_FILENAME=$(realpath $1)

ENVFILE="envfile"
env | sort > $ENVFILE
pwd
# When running with afl-fuzz this script receives 198/199 as pipes for RPC with the forkserver.
# To forward these into the restored process we use --inherit-fd.
# The target for --inherit-fd within the restored process are the named pipes that are stored in the pipes file.
PIPE1=$(cat ./pipes | grep -o "pipe:\[.*\]" | head -n 1 )
PIPE2=$(cat ./pipes | grep -o "pipe:\[.*\]" | head -n 2 | tail -n 1 )

# echo "PIPE1:\"$PIPE1\""
# echo "PIPE2:\"$PIPE2\""

#echo "======="
#cp $INPUT_FILENAME /tmp
#ls -la
#echo $INPUT_FILENAME
#ls -la /proc/self/fd
#pwd
#echo $@
#echo "======="

echo -n "" > ./out/.cur_input

if [[ -z "${__AFL_SHM_ID}" ]]; then
  exec 198< /dev/null
  exec 199> /dev/null
else
  echo "Running in AFL, no dummy FDs necessary"
fi

if [[ -z "$2" ]]; then
  SNAPSHOT_DIR="./snapshot"
else
  SNAPSHOT_DIR=$2
fi

## TEMPLATE ##

../criu/criu/criu restore -d \
    -vvv \
    -o ./restore.log \
    --images-dir $SNAPSHOT_DIR \
    --inherit-fd "fd[198]:$PIPE1" \
    --inherit-fd "fd[199]:$PIPE2" \